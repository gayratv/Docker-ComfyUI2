# Определяем аргумент для базового образа
ARG BASE_IMAGE="gayrat/comfyui-base-cuda-12-4:v2.0"

# Используем аргумент в качестве имени образа
FROM ${BASE_IMAGE}

WORKDIR /usr/local/bin
COPY *.sh ./
RUN chmod +x ./*.sh

WORKDIR /workspace
ARG COMFYUI_VERSION="latest"
ARG CUDA_VER="12.4"
ARG COMFYUI_VERSION

# очистка кеширующей директории
# RUN --mount=type=cache,target=/root/repo-cache rm -rf /root/repo-cache/*

# #13
RUN --mount=type=cache,target=/root/repo-cache \
    rm -rf /workspace/* && \
    git-clone-checkout.sh "https://github.com/comfyanonymous/ComfyUI" "$COMFYUI_VERSION" "/root/repo-cache" \
    && ls /root/repo-cache

WORKDIR /workspace/ComfyUI

COPY nodes.txt *.py ./

RUN --mount=type=cache,target=/root/repo-cache \
    --mount=type=cache,target=/root/pip-cache \
    PIP_CACHE_DIR=/root/pip-cache \
    process_repos-install-req.sh "$NODES" false \
    && rm -rf root/.cache/pip

ARG REQ_MODIFY="base-CUDA-12.4"
COPY requirements-modify ./requirements-modify


RUN  python3 union-requiere.py \
     && python3 process-req-in.py \
            --requirements-file "requirements.in" \
            --prefixes-file "./requirements-modify/$REQ_MODIFY/remove-lines.txt" \
            --additional-lines-file "./requirements-modify/$REQ_MODIFY/add-lines.txt";


RUN uv pip compile requirements.modify.in -o requirements.out \
        --index-strategy unsafe-best-match \
        --extra-index-url https://download.pytorch.org/whl/cu124 \
        --extra-index-url https://pypi.nvidia.com

  # Разбиение скомпилированных пакетов на группы
RUN python3 pip-pckg-group.py


RUN --mount=type=cache,target=/root/pip-cache-uv \
    uv pip install \
    --link-mode=copy \
    --system \
    --cache-dir=/root/pip-cache-uv \
    --index-strategy unsafe-best-match \
    --extra-index-url https://download.pytorch.org/whl/cu124 \
    --extra-index-url https://pypi.nvidia.com \
    -r requirements.out \
    && rm -rf /root/.cache/pip

WORKDIR /workspace/ComfyUI

RUN echo "cd /workspace" >> /root/.bashrc

CMD ["bash"]